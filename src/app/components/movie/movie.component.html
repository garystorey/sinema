@if (movie.title) {
<div class="movie-page">
  <div class="page-header">
    <button class="back-btn" (click)="goBack()" aria-label="Go back">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
      Back
    </button>
    <h1 class="movie-title">{{movie.title}}</h1>
  </div>
  <div class="main-content">
    <!-- Left: Poster -->
    <div class="poster-section">
      @if (movie.poster_path && !posterFailed) {
        <img [src]="getPosterPath()" [alt]="movie.title + ' poster'" class="movie-poster" (error)="posterFailed = true">
      } @else {
        <div class="movie-poster-placeholder">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect>
            <line x1="7" y1="2" x2="7" y2="22"></line>
            <line x1="17" y1="2" x2="17" y2="22"></line>
            <line x1="2" y1="12" x2="22" y2="12"></line>
            <line x1="2" y1="7" x2="7" y2="7"></line>
            <line x1="2" y1="17" x2="7" y2="17"></line>
            <line x1="17" y1="7" x2="22" y2="7"></line>
            <line x1="17" y1="17" x2="22" y2="17"></line>
          </svg>
          <span class="placeholder-title">{{movie.title}}</span>
        </div>
      }
    </div>

    <!-- Right: All Details -->
    <div class="details-section">
      @if (movie.tagline) {
        <p class="tagline">{{movie.tagline}}</p>
      }

      <div class="star-rating" role="img" [attr.aria-label]="'Rating: ' + (movie.vote_average | number:'1.0-1') + ' out of 10'">
        @for (star of getStars(); track $index) {
          @if (star === 'full') {
            <svg class="star star-full" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z"/></svg>
          } @else if (star === 'half') {
            <svg class="star star-half" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
              <defs><clipPath id="halfClip"><rect x="0" y="0" width="12" height="24"/></clipPath></defs>
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z" fill="currentColor" opacity="0.25"/>
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z" fill="currentColor" clip-path="url(#halfClip)"/>
            </svg>
          } @else {
            <svg class="star star-empty" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z"/></svg>
          }
        }
        <span class="star-score">{{movie.vote_average | number:'1.0-1'}} / 10</span>
      </div>

      @if (genreNames.length > 0) {
        <div class="genres">
          @for(name of genreNames; track $index) {
            <span class="genre-tag">{{name}}</span>
          }
        </div>
      }

      <div class="detail-rows">
        @if (movie.runtime) {
          <span class="detail-item">
            <span class="detail-label">Runtime:</span>
            <span class="detail-value">{{formatRuntime(movie.runtime)}}</span>
          </span>
        }
        <span class="detail-item">
          <span class="detail-label">Release Date:</span>
          <span class="detail-value">{{movie.release_date}}</span>
        </span>
        @if (languages.length > 0) {
          <span class="detail-item">
            <span class="detail-label">Languages:</span>
            <span class="detail-value">{{languages.join(', ')}}</span>
          </span>
        }
        @if (directors.length > 0) {
          <span class="detail-item">
            <span class="detail-label">Director:</span>
            <span class="detail-value">
              @for (d of directors; track d.id; let last = $last) {
                <a class="director-link" [routerLink]="['/person', d.id]">{{d.name}}</a>@if (!last) {,&nbsp;}
              }
            </span>
          </span>
        }
        @if (movie.budget && movie.budget > 0) {
          <span class="detail-item">
            <span class="detail-label">Budget:</span>
            <span class="detail-value">{{movie.budget | currency:'USD':'symbol':'1.0-0'}}</span>
          </span>
        }
        @if (movie.revenue && movie.revenue > 0) {
          <span class="detail-item">
            <span class="detail-label">Revenue:</span>
            <span class="detail-value">{{movie.revenue | currency:'USD':'symbol':'1.0-0'}}</span>
          </span>
        }
      </div>

      <div class="overview">
        <h2 class="section-title">Overview</h2>
        <p>{{movie.overview}}</p>
      </div>

      <div class="action-buttons">
        @if (trailerKey) {
          <button class="btn btn-primary" (click)="playTrailer()">
            <i class="fas fa-play"></i> Watch Trailer
          </button>
        }
        <button class="btn btn-secondary" (click)="toggleFavorite()" [class.btn-favorited]="isFavorited">
          @if (isFavorited) {
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            Remove from Favorites
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            Add to Favorites
          }
        </button>
      </div>

      @if (topCast.length > 0) {
        <div class="cast-section">
          <h2 class="section-title">Cast</h2>
          <div class="cast-grid">
            @for (member of topCast; track member.id) {
              <a class="cast-card" [routerLink]="['/person', member.id]">
                @if (member.profile_path) {
                  <img [src]="getProfilePath(member.profile_path)" [alt]="member.name" class="cast-photo">
                } @else {
                  <div class="cast-photo-placeholder">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                      <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                  </div>
                }
                <span class="cast-name">{{member.name}}</span>
                <span class="cast-character">{{member.character}}</span>
              </a>
            }
          </div>
        </div>
      }

      @if (topCrew.length > 0) {
        <div class="crew-section">
          <h2 class="section-title">Crew</h2>
          <div class="cast-grid">
            @for (member of topCrew; track member.id) {
              <a class="cast-card" [routerLink]="['/person', member.id]">
                @if (member.profile_path) {
                  <img [src]="getProfilePath(member.profile_path)" [alt]="member.name" class="cast-photo">
                } @else {
                  <div class="cast-photo-placeholder">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                      <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                  </div>
                }
                <span class="cast-name">{{member.name}}</span>
                <span class="cast-character">{{member.job}}</span>
              </a>
            }
          </div>
        </div>
      }

      @if (relatedMovies.length > 0) {
        <div class="related-section">
          <h2 class="section-title">Related Movies</h2>
          <div class="related-grid">
            @for (movie of relatedMovies; track movie.id) {
              <app-moviecard [movie]="movie"></app-moviecard>
            }
          </div>
        </div>
      }

    </div>
  </div>

  @if (showTrailer) {
    <div class="trailer-overlay" (click)="closeTrailer()">
      <div class="trailer-modal" (click)="$event.stopPropagation()">
        <button class="trailer-close-btn" (click)="closeTrailer()" aria-label="Close trailer">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <iframe
          [src]="getTrailerUrl()"
          frameborder="0"
          allow="autoplay; encrypted-media"
          allowfullscreen
          class="trailer-iframe">
        </iframe>
      </div>
    </div>
  }
</div>
}
@else if (loading) {
<app-loader message="Loading movie..."></app-loader>
} @else {
<p class="no-movie">No movie found</p>
}
